<div id="linkingContainer">
  <div class="card card-body">
    <h2 style="font-size: 0.9rem; font-weight: 300;">Automatic Configuration</h2>
    <button class="btn btn-primary" id="generateQR" style="font-weight: 400; padding: .375rem .75rem; font-size: 1rem; line-height: 1.5; border-radius: .25rem; text-transform: uppercase;">Begin Device Linking</button>
    <!-- Added style to center the QR code -->
    <div id="qrCodeArea" class="mt-3" style="text-align: center;"></div>
    <div id="linkStatus" class="mt-2"></div>
  </div>
</div>

<!-- Removed "display:none;" to always show the form -->


<script>
  (async () => {
    // Hide spinner on initial load.
    homebridge.hideSpinner();

    // Retrieve current plugin configuration.
    const pluginConfig = await homebridge.getPluginConfig();
    let config = pluginConfig.length ? pluginConfig[0] : {};
    if (!pluginConfig.length) {
      pluginConfig.push(config);
    }
    homebridge.showSchemaForm();

    // If config is already saved, immediately show the config form below the linking section.
    //if (config.token && config.phoneNumber && config.tokenType !== undefined) {
    //  homebridge.showSchemaForm();
    //}

    // Linking flow variables.
    let uniqueId = null;
    let pollInterval = null;
    let linkingComplete = false; // Guard flag to prevent multiple success events

    document.getElementById('generateQR').addEventListener('click', async () => {
  // Clear any existing polling interval and reset linking flag.
  if (pollInterval) {
    clearInterval(pollInterval);
  }
  linkingComplete = false;

  homebridge.showSpinner();
  document.getElementById('qrCodeArea').innerText = 'Generating QR code...';
  document.getElementById('linkStatus').innerText = '';

  try {
    // Call /link/init to get a new uniqueId and QR code.
    const initData = await homebridge.request('/link/init');
    if (!initData.success) {
      throw new Error(initData.error || 'Failed to initiate linking.');
    }
    uniqueId = initData.uniqueId;
    document.getElementById('qrCodeArea').innerHTML = `<img src="${initData.qrCode}" alt="QR Code" style="max-width:100%;">`;

    // Start polling /link/confirm every 3 seconds.
    pollInterval = setInterval(async () => {
      try {
        const confirmData = await homebridge.request('/link/confirm', { uniqueId });
        if (confirmData.success) {
          if (!linkingComplete) {
            linkingComplete = true;
            clearInterval(pollInterval);
            // Remove the QR code and update status text.
            document.getElementById('qrCodeArea').innerHTML = '';
            document.getElementById('linkStatus').innerText = 'Linking complete, plugin configuration updated.';

            // Update config with the new linking data.
            config.token = confirmData.sessionToken;
            config.phoneNumber = confirmData.phoneNumber;
            config.tokenType = parseInt(confirmData.tokenType, 10);
            if (!config.accessoryType) {
              config.accessoryType = 'garageDoor';
            }
            pluginConfig[0] = config;
            await homebridge.updatePluginConfig(pluginConfig);
            // Re-create the configuration form to reflect updated config.
            homebridge.showSchemaForm();
          }
        } else if (confirmData.waiting) {
          document.getElementById('linkStatus').innerText = 'Waiting for scan confirmation...';
        } else {
          clearInterval(pollInterval);
          homebridge.toast.error(confirmData.error || 'Unknown error', 'Error');
        }
      } catch (err) {
        clearInterval(pollInterval);
        homebridge.toast.error(err.toString(), 'Error');
      }
    }, 3000);
  } catch (err) {
    homebridge.toast.error(err.toString(), 'Error');
  } finally {
    homebridge.hideSpinner();
  }
});
  })();
</script>